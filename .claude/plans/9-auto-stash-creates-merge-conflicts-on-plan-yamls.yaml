meta:
  name: Fix Auto-Stash Merge Conflicts on Plan YAMLs
  description: Exclude plan YAMLs from git stash and improve merge-conflict recovery
    in git_stash_pop() to prevent self-inflicted merge conflicts during task execution.
  source_item: docs/defect-backlog/9-auto-stash-creates-merge-conflicts-on-plan-yamls.md
  plan_doc: docs/plans/2026-02-19-9-auto-stash-creates-merge-conflicts-on-plan-yamls-design.md
  created: '2026-02-19'
  max_attempts_default: 3
  validation:
    enabled: true
    run_after:
    - coder
    validators:
    - validator
    max_validation_attempts: 2
sections:
- id: phase-1
  name: Phase 1 - Fix stash exclusion and recovery
  status: pending
  tasks:
  - id: '1.1'
    name: Exclude plan YAMLs from stash and improve recovery
    agent: coder
    status: pending
    description: >
      Implement the work item: docs/defect-backlog/9-auto-stash-creates-merge-conflicts-on-plan-yamls.md

      Design reference: docs/plans/2026-02-19-9-auto-stash-creates-merge-conflicts-on-plan-yamls-design.md

      Apply Option C (defense in depth) from the defect report:

      1. Add constant STASH_EXCLUDE_PLANS_PATHSPEC = ":(exclude).claude/plans/"
         near the existing ORCHESTRATOR_STASH_MESSAGE constant.

      2. In git_stash_working_changes(), change the stash push command to use
         pathspec exclusion so plan YAMLs are never stashed:
         ["git", "stash", "push", "--include-untracked", "-m", ORCHESTRATOR_STASH_MESSAGE,
          "--", ".", STASH_EXCLUDE_PLANS_PATHSPEC]

      3. In git_stash_pop(), add git reset --merge before git checkout . in
         the recovery path to properly clear merge state.

      4. Update existing tests in tests/test_plan_orchestrator.py:
         - test_git_stash_working_changes_dirty_tree: verify pathspec args
         - test_git_stash_pop_conflict: verify reset --merge in recovery
         - Add test_git_stash_pop_conflict_calls_reset_merge for exact sequence

      5. Run tests: ~/.pyenv/versions/3.11.*/bin/python -m pytest tests/ -v
         Fix any failures.

      Files: scripts/plan-orchestrator.py, tests/test_plan_orchestrator.py
