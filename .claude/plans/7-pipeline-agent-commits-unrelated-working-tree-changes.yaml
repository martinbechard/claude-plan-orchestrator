meta:
  name: Fix Pipeline Agent Commits Unrelated Working-Tree Changes
  description: 'Add git stash/pop around sequential task execution so sub-agents only
    see a clean working tree plus their own changes. This prevents agents from accidentally
    committing unrelated concurrent edits. Two new helper functions (git_stash_working_changes,
    git_stash_pop) and integration into the sequential execution loop in plan-orchestrator.py.

    '
  plan_doc: docs/plans/2026-02-17-7-pipeline-agent-commits-unrelated-working-tree-changes-design.md
  created: '2026-02-17'
  max_attempts_default: 3
  validation:
    enabled: true
    run_after:
    - coder
    validators:
    - issue-verifier
    max_validation_attempts: 1
sections:
- id: phase-1
  name: Phase 1 - Implementation
  status: completed
  tasks:
  - id: '1.1'
    name: Add git stash helper functions
    agent: coder
    status: completed
    description: "Add two new helper functions to scripts/plan-orchestrator.py for\
      \ git stash management. Place them near the existing git-related helpers (around\
      \ the save_plan function at line ~1423).\nReference: docs/plans/2026-02-17-7-pipeline-agent-commits-unrelated-working-tree-changes-design.md\n\
      Add a constant near the top of the file (with other constants):\n  ORCHESTRATOR_STASH_MESSAGE\
      \ = \"orchestrator-auto-stash\"\n\nFunction 1: git_stash_working_changes() ->\
      \ bool\n  - First check if there are any uncommitted changes by running:\n \
      \   git diff --quiet && git diff --cached --quiet && git ls-files --others --exclude-standard\n\
      \  - If the tree is clean (both diffs exit 0 and no untracked files), return\
      \ False\n  - Otherwise run: git stash push --include-untracked -m ORCHESTRATOR_STASH_MESSAGE\n\
      \  - Check exit code. If success, print \"[Stashed working-tree changes before\
      \ task]\"\n    and return True\n  - If stash command fails, print a warning\
      \ and return False\n  - Use subprocess.run with capture_output=True for all\
      \ git commands\n\nFunction 2: git_stash_pop() -> bool\n  - Run: git stash pop\n\
      \  - If exit code 0, print \"[Restored stashed working-tree changes]\" and return\
      \ True\n  - If exit code non-zero, print a warning:\n    \"[WARNING] git stash\
      \ pop failed - stash preserved for manual resolution\"\n    Also print the stderr\
      \ from the failed command for debugging\n  - Return False on failure\n  - Use\
      \ subprocess.run with capture_output=True\n\nFiles: scripts/plan-orchestrator.py\n"
    attempts: 1
    last_attempt: '2026-02-17T19:33:43.318606'
    model_used: sonnet
    completed_at: '2026-02-17T19:36:00.077596'
    result_message: Added ORCHESTRATOR_STASH_MESSAGE constant and git_stash_working_changes()/git_stash_pop()
      helper functions to scripts/plan-orchestrator.py. Functions placed after save_plan()
      at line ~1449. Syntax verified clean.
  - id: '1.2'
    name: Integrate stash/pop into sequential execution loop
    agent: coder
    status: completed
    depends_on:
    - '1.1'
    description: "Modify the sequential execution path in execute_plan() within scripts/plan-orchestrator.py\
      \ to wrap each task with stash/pop calls.\nReference: docs/plans/2026-02-17-7-pipeline-agent-commits-unrelated-working-tree-changes-design.md\n\
      In the sequential execution block (around line 4490, after \"Mark as in progress\"\
      \ and the save_plan call, before \"Build and execute prompt\"):\n1. Add stash\
      \ call BEFORE the prompt build (around line 4500):\n   stash_created = False\n\
      \   if not dry_run:\n       stash_created = git_stash_working_changes()\n\n\
      2. Add pop call AFTER the task result processing is complete. This must\n  \
      \ happen regardless of task success or failure. Use a try/finally pattern:\n\
      \n   Wrap the prompt build + run_claude_task + result processing in a\n   try/finally\
      \ block where the finally clause does:\n     if stash_created:\n         git_stash_pop()\n\
      \n   The try block should start just after the stash call and the finally\n\
      \   block should be placed after all result processing (after the\n   save_plan\
      \ call for task completion/failure, around line 4620+).\n\n3. Make sure the\
      \ stash pop happens even if the task raises an exception.\n4. Do NOT add stash/pop\
      \ to the parallel execution path (worktree-based) -\n   that path already provides\
      \ isolation.\n\nFiles: scripts/plan-orchestrator.py\n"
    attempts: 1
    last_attempt: '2026-02-17T19:36:02.382840'
    model_used: sonnet
    completed_at: '2026-02-17T19:39:42.832968'
    result_message: Integrated git stash/pop into sequential execution loop in execute_plan().
      Added stash call before prompt build (skipped in dry_run), wrapped entire task
      execution block (clear_status_file through backoff sleep) in try/finally, finally
      clause calls git_stash_pop() when stash_created is True. Syntax verified clean.
- id: phase-2
  name: Phase 2 - Unit Tests
  status: pending
  tasks:
  - id: '2.1'
    name: Add unit tests for stash helpers
    agent: coder
    status: pending
    depends_on:
    - '1.2'
    description: "Add unit tests for the git stash helper functions in tests/test_plan_orchestrator.py.\n\
      Reference: docs/plans/2026-02-17-7-pipeline-agent-commits-unrelated-working-tree-changes-design.md\n\
      First, import the new functions from the module (the module is already imported\
      \ via importlib at the top of the file as 'mod'):\n  git_stash_working_changes\
      \ = mod.git_stash_working_changes\n  git_stash_pop = mod.git_stash_pop\n  ORCHESTRATOR_STASH_MESSAGE\
      \ = mod.ORCHESTRATOR_STASH_MESSAGE\n\nAdd these test cases:\n1. test_git_stash_working_changes_clean_tree:\n\
      \   - Mock subprocess.run to simulate a clean working tree (git diff --quiet\n\
      \     exits 0, no untracked files)\n   - Assert function returns False\n   -\
      \ Assert git stash push was NOT called\n\n2. test_git_stash_working_changes_dirty_tree:\n\
      \   - Mock subprocess.run to simulate a dirty tree (git diff --quiet exits\n\
      \     non-zero)\n   - Assert function returns True\n   - Assert git stash push\
      \ was called with correct arguments including\n     --include-untracked and\
      \ the stash message\n\n3. test_git_stash_working_changes_stash_fails:\n   -\
      \ Mock subprocess.run so the dirty check returns dirty but the stash\n     push\
      \ command fails\n   - Assert function returns False\n\n4. test_git_stash_pop_success:\n\
      \   - Mock subprocess.run to simulate successful git stash pop\n   - Assert\
      \ function returns True\n\n5. test_git_stash_pop_conflict:\n   - Mock subprocess.run\
      \ to simulate git stash pop failure (exit code 1)\n   - Assert function returns\
      \ False\n\nUse unittest.mock.patch to mock subprocess.run. Match on the git\
      \ command arguments to return appropriate mock results for different calls.\n\
      After writing the tests, run them:\n  ~/.pyenv/versions/3.11.*/bin/python -m\
      \ pytest tests/test_plan_orchestrator.py -v\n\nFix any failures before completing.\n\
      Files: tests/test_plan_orchestrator.py\n"
- id: phase-3
  name: Phase 3 - Verification
  status: pending
  tasks:
  - id: '3.1'
    name: Verify syntax and run tests
    agent: code-reviewer
    status: pending
    depends_on:
    - '2.1'
    description: "Verify the implementation compiles and tests pass.\nSteps: 1. Check\
      \ Python syntax for both main scripts:\n   python3 -c \"import py_compile; py_compile.compile('scripts/auto-pipeline.py',\
      \ doraise=True); py_compile.compile('scripts/plan-orchestrator.py', doraise=True)\"\
      \n\n2. Run all unit tests:\n   python3 -m pytest tests/ 2>/dev/null || echo\
      \ 'No test suite configured'\n\n3. Verify the new constant exists:\n   grep\
      \ -c \"ORCHESTRATOR_STASH_MESSAGE\" scripts/plan-orchestrator.py\n   (should\
      \ return 2 or more - definition + usage)\n\n4. Verify the new functions exist:\n\
      \   grep -c \"def git_stash_working_changes\" scripts/plan-orchestrator.py\n\
      \   grep -c \"def git_stash_pop\" scripts/plan-orchestrator.py\n   (each should\
      \ return 1)\n\n5. Verify stash integration in the sequential path:\n   grep\
      \ -c \"git_stash_working_changes\" scripts/plan-orchestrator.py\n   (should\
      \ return 2+ - definition + call site)\n   grep -c \"git_stash_pop\" scripts/plan-orchestrator.py\n\
      \   (should return 2+ - definition + call site)\n\n6. Run orchestrator dry-run\
      \ to confirm no startup errors:\n   python3 scripts/plan-orchestrator.py --plan\
      \ .claude/plans/sample-plan.yaml --dry-run\n\nIf any check fails, report the\
      \ failure details.\nFiles: scripts/plan-orchestrator.py, tests/test_plan_orchestrator.py\n"
