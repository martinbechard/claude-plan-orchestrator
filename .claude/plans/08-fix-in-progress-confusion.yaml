meta:
  name: Fix Subagent Confusion About in_progress Task Status
  description: 'Eliminate subagent confusion when a task is on its first attempt by
    making the prompt context-aware about attempt numbers. On attempt 1, clarify that
    in_progress is expected. On attempt 2+, explicitly state the retry context. Single
    file change in scripts/plan-orchestrator.py.

    '
  plan_doc: docs/plans/2026-02-13-08-fix-in-progress-confusion-design.md
  created: '2026-02-13'
  max_attempts_default: 3
sections:
- id: phase-1
  name: Phase 1 - Implementation
  status: completed
  tasks:
  - id: '1.1'
    name: Make build_claude_prompt attempt-aware
    status: completed
    description: "Modify build_claude_prompt in scripts/plan-orchestrator.py to accept\
      \ an\nattempt_number parameter and conditionally generate the state-verification\n\
      instruction.\n\nReference: docs/plans/2026-02-13-08-fix-in-progress-confusion-design.md\n\
      \nSteps:\n1. Add attempt_number: int = 1 parameter to the function signature\
      \ (line ~1178).\n   Update the docstring to document it.\n\n2. Replace the hardcoded\
      \ line (~1265):\n     1. First, verify the current state - a previous attempt\
      \ may have failed\n   With a conditional block:\n   - When attempt_number ==\
      \ 1:\n       1. This is a fresh start (attempt 1). The task shows as in_progress\
      \ because\n          the orchestrator assigned it to you. Start working immediately\
      \ on the task.\n   - When attempt_number >= 2:\n       1. This is attempt {attempt_number}.\
      \ A previous attempt failed. Check the\n          current state before proceeding\
      \ - some work may already be done.\n\n   Use Python string formatting or an\
      \ if/else to build the instruction text\n   before the f-string return.\n\n\
      3. Update both call sites to pass the attempt number:\n\n   Sequential path\
      \ (line ~2040):\n     prompt = build_claude_prompt(plan, section, task, plan_path,\n\
      \                                  attempt_number=task.get(\"attempts\", 1))\n\
      \n   Parallel path (line ~1073):\n     prompt = build_claude_prompt(plan, section,\
      \ task, plan_path, subagent_context,\n                                  attempt_number=task.get(\"\
      attempts\", 1))\n\nFiles: scripts/plan-orchestrator.py\n"
    attempts: 1
    last_attempt: '2026-02-13T23:02:22.807877'
    completed_at: '2026-02-13T23:04:42.660708'
    result_message: 'Made build_claude_prompt attempt-aware: added attempt_number
      parameter with default 1, replaced hardcoded ''previous attempt may have failed''
      with conditional text (fresh start vs retry), updated both sequential and parallel
      call sites to pass task attempts.'
- id: phase-2
  name: Phase 2 - Verification
  status: pending
  tasks:
  - id: '2.1'
    name: Verify syntax and dry-run
    status: pending
    description: "Verify the changes compile and the orchestrator still runs correctly.\n\
      \nSteps:\n1. Check Python syntax:\n   python3 -c \"import py_compile; py_compile.compile('scripts/plan-orchestrator.py',\
      \ doraise=True); print('syntax OK')\"\n\n2. Run orchestrator dry-run:\n   python\
      \ scripts/plan-orchestrator.py --plan .claude/plans/sample-plan.yaml --dry-run\n\
      \n3. Verify the old text is gone:\n   grep -c \"a previous attempt may have\
      \ failed\" scripts/plan-orchestrator.py\n   (should return 0)\n\n4. Verify new\
      \ text exists:\n   grep -c \"fresh start\" scripts/plan-orchestrator.py\n  \
      \ (should return 1 or more)\n   grep -c \"attempt_number\" scripts/plan-orchestrator.py\n\
      \   (should return several matches for the parameter and its usage)\n\nIf any\
      \ check fails, fix the issue in scripts/plan-orchestrator.py and re-run.\n\n\
      Files: scripts/plan-orchestrator.py\n"
    depends_on:
    - '1.1'
    max_attempts: 5
