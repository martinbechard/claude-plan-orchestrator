meta:
  name: Fix Subagent Confusion About in_progress Task Status
  description: >
    Eliminate subagent confusion when a task is on its first attempt by making the
    prompt context-aware about attempt numbers. On attempt 1, clarify that in_progress
    is expected. On attempt 2+, explicitly state the retry context. Single file change
    in scripts/plan-orchestrator.py.
  plan_doc: docs/plans/2026-02-13-08-fix-in-progress-confusion-design.md
  created: '2026-02-13'
  max_attempts_default: 3

sections:
- id: phase-1
  name: Phase 1 - Implementation
  status: pending
  tasks:
  - id: '1.1'
    name: Make build_claude_prompt attempt-aware
    status: pending
    description: |
      Modify build_claude_prompt in scripts/plan-orchestrator.py to accept an
      attempt_number parameter and conditionally generate the state-verification
      instruction.

      Reference: docs/plans/2026-02-13-08-fix-in-progress-confusion-design.md

      Steps:
      1. Add attempt_number: int = 1 parameter to the function signature (line ~1178).
         Update the docstring to document it.

      2. Replace the hardcoded line (~1265):
           1. First, verify the current state - a previous attempt may have failed
         With a conditional block:
         - When attempt_number == 1:
             1. This is a fresh start (attempt 1). The task shows as in_progress because
                the orchestrator assigned it to you. Start working immediately on the task.
         - When attempt_number >= 2:
             1. This is attempt {attempt_number}. A previous attempt failed. Check the
                current state before proceeding - some work may already be done.

         Use Python string formatting or an if/else to build the instruction text
         before the f-string return.

      3. Update both call sites to pass the attempt number:

         Sequential path (line ~2040):
           prompt = build_claude_prompt(plan, section, task, plan_path,
                                        attempt_number=task.get("attempts", 1))

         Parallel path (line ~1073):
           prompt = build_claude_prompt(plan, section, task, plan_path, subagent_context,
                                        attempt_number=task.get("attempts", 1))

      Files: scripts/plan-orchestrator.py

- id: phase-2
  name: Phase 2 - Verification
  status: pending
  tasks:
  - id: '2.1'
    name: Verify syntax and dry-run
    status: pending
    description: |
      Verify the changes compile and the orchestrator still runs correctly.

      Steps:
      1. Check Python syntax:
         python3 -c "import py_compile; py_compile.compile('scripts/plan-orchestrator.py', doraise=True); print('syntax OK')"

      2. Run orchestrator dry-run:
         python scripts/plan-orchestrator.py --plan .claude/plans/sample-plan.yaml --dry-run

      3. Verify the old text is gone:
         grep -c "a previous attempt may have failed" scripts/plan-orchestrator.py
         (should return 0)

      4. Verify new text exists:
         grep -c "fresh start" scripts/plan-orchestrator.py
         (should return 1 or more)
         grep -c "attempt_number" scripts/plan-orchestrator.py
         (should return several matches for the parameter and its usage)

      If any check fails, fix the issue in scripts/plan-orchestrator.py and re-run.

      Files: scripts/plan-orchestrator.py
    depends_on:
    - '1.1'
    max_attempts: 5
