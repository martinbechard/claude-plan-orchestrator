meta:
  name: Prevent Premature completed/ Subfolder Moves and Ensure Archive Runs Exactly
    Once
  description: 'Two targeted fixes in archive_item() and _resolve_item_path(): (1)
    Add an idempotency guard in archive_item() so a second call for the same item
    is a no-op success rather than an error or silent overwrite. (2) Upgrade the log
    in _resolve_item_path() from info to WARNING when a file is found in the completed/
    subfolder, making premature mid-pipeline relocations visible in monitoring.'
  plan_doc: docs/plans/2026-02-18-2-prevent-premature-completed-subfolder-moves-and-ensure-archive-runs-exactly-once-design.md
  created: '2026-02-18'
  max_attempts_default: 3
  validation:
    enabled: true
    run_after:
    - coder
    validators:
    - issue-verifier
    max_validation_attempts: 1
sections:
- id: phase-1
  name: Phase 1 - Implementation
  status: completed
  tasks:
  - id: '1.1'
    name: Add idempotency guard and upgrade premature-move log level
    agent: coder
    status: completed
    description: "Apply two targeted fixes to scripts/auto-pipeline.py.\n\nReference\
      \ design: docs/plans/2026-02-18-2-prevent-premature-completed-subfolder-moves-and-ensure-archive-runs-exactly-once-design.md\n\
      \n### Fix 1 — Idempotent archive_item()\n\nRead scripts/auto-pipeline.py and\
      \ locate archive_item() (around line 1394).\n\nAfter the `if dry_run:` block\
      \ and before the `source = _resolve_item_path(item)` line,\ninsert the following\
      \ idempotency guard:\n\n    if os.path.exists(dest):\n        log(f\"[ARCHIVE]\
      \ Already archived, skipping: {dest}\")\n        return True\n\nThe resulting\
      \ function body must follow this order:\n  1. Compute dest_dir and dest (already\
      \ present).\n  2. dry_run short-circuit (already present).\n  3. NEW: dest-exists\
      \ idempotency guard (return True if already archived).\n  4. source = _resolve_item_path(item)\
      \ (already present).\n  5. source is None guard (already present).\n  6. makedirs\
      \ + shutil.move + git commit (already present).\n\n### Fix 2 — Upgrade log level\
      \ in _resolve_item_path()\n\nLocate _resolve_item_path() (around line 1375).\
      \ Find the log() call inside\nthe `if os.path.exists(candidate):` branch. Replace:\n\
      \n    log(f\"[ARCHIVE] Item relocated to completed/ subfolder, using: {candidate}\"\
      )\n\nwith:\n\n    log(f\"WARNING: [ARCHIVE] Item relocated to completed/ subfolder\
      \ — unexpected mid-pipeline move: {candidate}\")\n\n### Verification after changes\n\
      \nRun syntax check:\n  python3 -c \"import py_compile; py_compile.compile('scripts/auto-pipeline.py',\
      \ doraise=True); print('syntax OK')\"\n\nRun quick smoke test to confirm both\
      \ behaviors:\n  python3 -c \"\n  import importlib.util, tempfile, os, subprocess\n\
      \  from pathlib import Path\n  from unittest.mock import patch\n  spec = importlib.util.spec_from_file_location('ap',\
      \ 'scripts/auto-pipeline.py')\n  mod = importlib.util.module_from_spec(spec)\n\
      \  spec.loader.exec_module(mod)\n\n  with tempfile.TemporaryDirectory() as tmp:\n\
      \      # Test idempotency: dest already exists\n      dest_dir = Path(tmp) /\
      \ 'completed'\n      dest_dir.mkdir()\n      dest_file = dest_dir / 'item.md'\n\
      \      dest_file.write_text('content')\n\n      item = mod.BacklogItem(path=str(Path(tmp)\
      \ / 'item.md'), name='Item', slug='item', item_type='defect')\n      with patch.dict('os.environ'),\
      \ patch.object(mod, 'COMPLETED_DIRS', {'defect': str(dest_dir)}):\n        \
      \  result = mod.archive_item(item, dry_run=False)\n      assert result is True,\
      \ 'Idempotency: already-archived item should return True'\n\n      # Test premature-move\
      \ warning: file in completed/ subfolder emits WARNING\n      backlog_dir = Path(tmp)\
      \ / 'defect-backlog'\n      backlog_dir.mkdir()\n      comp_dir = backlog_dir\
      \ / 'completed'\n      comp_dir.mkdir()\n      moved_file = comp_dir / 'other.md'\n\
      \      moved_file.write_text('content')\n      item2 = mod.BacklogItem(path=str(backlog_dir\
      \ / 'other.md'), name='Other', slug='other', item_type='defect')\n      resolved\
      \ = mod._resolve_item_path(item2)\n      assert resolved == str(moved_file),\
      \ 'Should resolve to completed/ path'\n\n  print('smoke tests OK')\n  \"\n\n\
      Files: scripts/auto-pipeline.py\n"
    attempts: 1
    last_attempt: '2026-02-18T08:27:46.431279'
    model_used: sonnet
    completed_at: '2026-02-18T08:29:51.011479'
    result_message: 'Applied two targeted fixes to scripts/auto-pipeline.py: (1) added
      idempotency guard in archive_item() that checks if dest exists before resolving
      source, returning True without a git commit if already archived; (2) upgraded
      log in _resolve_item_path() from info to WARNING prefix for premature completed/
      subfolder moves. Both syntax check and smoke tests pass.'
- id: phase-2
  name: Phase 2 - Unit Tests
  status: pending
  tasks:
  - id: '2.1'
    name: Add regression tests for idempotency guard and premature-move warning
    agent: coder
    status: pending
    depends_on:
    - '1.1'
    description: "Add regression tests to tests/test_auto_pipeline.py for the two\
      \ new behaviors.\n\nReference design: docs/plans/2026-02-18-2-prevent-premature-completed-subfolder-moves-and-ensure-archive-runs-exactly-once-design.md\n\
      \nRead tests/test_auto_pipeline.py to understand existing structure. The module\
      \ is\nalready imported as `mod` via importlib. `archive_item` and `BacklogItem`\
      \ are\nalready imported at the top of the file from the existing defect-1 tests.\n\
      \nAdd the following test functions at the end of the file:\n\n### test_archive_item_idempotent_when_dest_exists(tmp_path,\
      \ monkeypatch)\n- Create an archive destination directory inside tmp_path.\n\
      - Write a file at dest_dir / \"my-item.md\" (simulating a previously archived\
      \ item).\n- Create a BacklogItem with path pointing to the original (non-existent)\
      \ backlog location.\n- Monkeypatch mod.COMPLETED_DIRS to point to the temp dest_dir.\n\
      - Monkeypatch subprocess.run to no-op (no real git calls).\n- Call archive_item(item,\
      \ dry_run=False).\n- Assert the function returns True (idempotency: already\
      \ archived => success).\n- Assert no subprocess.run call was made for git (no\
      \ git commit on re-archive).\n\n### test_archive_item_idempotent_does_not_overwrite(tmp_path,\
      \ monkeypatch)\n- Same setup as above, but verify the destination file content\
      \ is unchanged\n  after the idempotent call (the file should not have been moved/overwritten).\n\
      - Use a sentinel string in the pre-existing destination file and confirm it\
      \ is\n  still present after archive_item() returns.\n\n### test_resolve_item_path_warning_log_for_completed_subfolder(tmp_path,\
      \ capsys)\n- Create tmp_path / \"defect-backlog\" / \"completed\" directory.\n\
      - Write \"item.md\" inside the completed/ subfolder.\n- Create a BacklogItem\
      \ with path pointing to the non-existent root location.\n- Call _resolve_item_path(item).\n\
      - Capture stdout (the log() function writes to stdout).\n- Assert the output\
      \ contains \"WARNING\" to confirm the upgraded log level.\n\nRun tests after\
      \ adding them:\n  ~/.pyenv/versions/3.11.*/bin/python -m pytest tests/test_auto_pipeline.py\
      \ -v\n\nFix any failures immediately.\n\nFiles: tests/test_auto_pipeline.py\n"
- id: phase-3
  name: Phase 3 - Verification
  status: pending
  tasks:
  - id: '3.1'
    name: Final verification — syntax, full test suite, smoke test
    agent: code-reviewer
    status: pending
    depends_on:
    - '2.1'
    description: "Run all verification checks to confirm the fix is correct and complete.\n\
      \n1. Check Python syntax for both scripts:\n   python3 -c \"import py_compile;\
      \ py_compile.compile('scripts/auto-pipeline.py', doraise=True); py_compile.compile('scripts/plan-orchestrator.py',\
      \ doraise=True)\"\n\n2. Run the full test suite:\n   ~/.pyenv/versions/3.11.*/bin/python\
      \ -m pytest tests/ -v 2>/dev/null || echo 'No test suite configured'\n\n3. Confirm\
      \ archive_item() body has the idempotency guard before _resolve_item_path():\n\
      \   grep -n \"Already archived\" scripts/auto-pipeline.py\n\n4. Confirm _resolve_item_path()\
      \ log contains \"WARNING\":\n   grep -n \"WARNING.*completed/ subfolder\" scripts/auto-pipeline.py\n\
      \n5. Run orchestrator dry-run to confirm no startup errors:\n   python3 scripts/plan-orchestrator.py\
      \ --plan .claude/plans/sample-plan.yaml --dry-run\n\nReport any failures with\
      \ specific details. All checks must pass.\n\nFiles: scripts/auto-pipeline.py,\
      \ scripts/plan-orchestrator.py, tests/test_auto_pipeline.py\n"
