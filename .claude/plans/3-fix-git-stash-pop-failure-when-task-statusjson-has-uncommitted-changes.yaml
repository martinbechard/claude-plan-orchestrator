meta:
  name: Fix git stash pop failure when task-status.json has uncommitted changes
  description: 'Discard the orchestrator-owned task-status.json from the working tree
    immediately before git stash pop to prevent a merge conflict. The file is ephemeral:
    its content is already consumed by read_status_file() before the finally block
    runs, so discarding it is safe and avoids polluting git history with committed
    orchestrator state.'
  plan_doc: docs/plans/2026-02-18-3-fix-git-stash-pop-failure-when-task-statusjson-has-uncommitted-changes-design.md
  created: '2026-02-18'
  max_attempts_default: 3
  validation:
    enabled: true
    run_after:
    - coder
    validators:
    - issue-verifier
    max_validation_attempts: 1
sections:
- id: phase-1
  name: Phase 1 - Implementation
  status: completed
  tasks:
  - id: '1.1'
    name: Discard task-status.json before git stash pop
    agent: coder
    status: completed
    description: "Apply a targeted fix to git_stash_pop() in scripts/plan-orchestrator.py.\n\
      \nReference design: docs/plans/2026-02-18-3-fix-git-stash-pop-failure-when-task-statusjson-has-uncommitted-changes-design.md\n\
      \n## Background\n\nWhen git_stash_pop() is called in the finally block after\
      \ a task completes,\ntask-status.json (STATUS_FILE_PATH) may still exist as\
      \ an uncommitted file\nin the working tree. The stash pop fails with a conflict\
      \ because the stash\nalso contains that file.\n\ntask-status.json is orchestrator-owned\
      \ and ephemeral: it was already read by\nread_status_file() before the finally\
      \ block executes. Discarding it just\nbefore the pop is safe and correct.\n\n\
      ## Fix\n\nRead scripts/plan-orchestrator.py and locate git_stash_pop() (around\
      \ line 1505).\n\nBefore the subprocess.run([\"git\", \"stash\", \"pop\"], ...)\
      \ call, insert a block\nthat discards any uncommitted changes to STATUS_FILE_PATH:\n\
      \n    # Discard task-status.json before pop to prevent merge conflict.\n   \
      \ # The file is ephemeral: its content was already consumed by read_status_file().\n\
      \    if os.path.exists(STATUS_FILE_PATH):\n        subprocess.run(\n       \
      \     [\"git\", \"checkout\", \"--\", STATUS_FILE_PATH],\n            capture_output=True\n\
      \        )\n\nThe fix goes inside git_stash_pop(), before the existing subprocess.run\
      \ call.\nDo not change any other logic in the function.\n\n## Verification after\
      \ change\n\nRun syntax check:\n  python3 -c \"import py_compile; py_compile.compile('scripts/plan-orchestrator.py',\
      \ doraise=True); print('syntax OK')\"\n\nConfirm the checkout line is present:\n\
      \  grep -n \"checkout.*STATUS_FILE_PATH\\|checkout.*task-status\" scripts/plan-orchestrator.py\n\
      \nFiles: scripts/plan-orchestrator.py\n"
    attempts: 1
    last_attempt: '2026-02-18T08:40:41.014196'
    model_used: sonnet
    completed_at: '2026-02-18T08:42:04.340120'
    result_message: Added git checkout -- STATUS_FILE_PATH before git stash pop in
      git_stash_pop() to prevent merge conflict when task-status.json is present in
      working tree
- id: phase-2
  name: Phase 2 - Unit Tests
  status: completed
  tasks:
  - id: '2.1'
    name: Add regression test for stash pop with uncommitted task-status.json
    agent: coder
    status: completed
    depends_on:
    - '1.1'
    description: "Add a regression test to tests/test_plan_orchestrator.py that verifies\n\
      git_stash_pop() succeeds when task-status.json exists in the working tree.\n\
      \nReference design: docs/plans/2026-02-18-3-fix-git-stash-pop-failure-when-task-statusjson-has-uncommitted-changes-design.md\n\
      \n## Context\n\ntests/test_plan_orchestrator.py already imports:\n  - git_stash_pop\
      \ (from mod)\n  - git_stash_working_changes (from mod)\n  - ORCHESTRATOR_STASH_MESSAGE\
      \ (from mod)\n\nThe module (mod) is already loaded via importlib at the top\
      \ of the file.\nAlso import STATUS_FILE_PATH from mod at the top of the test\
      \ file.\n\n## Test to add\n\n### test_stash_pop_discards_task_status_json(tmp_path,\
      \ monkeypatch)\n\nThis test uses actual git subprocess calls against a temporary\
      \ git repo.\n\n1. Create a temporary git repository:\n     subprocess.run([\"\
      git\", \"init\"], cwd=str(tmp_path), check=True)\n     subprocess.run([\"git\"\
      , \"config\", \"user.email\", \"test@test.com\"], cwd=str(tmp_path), check=True)\n\
      \     subprocess.run([\"git\", \"config\", \"user.name\", \"Test\"], cwd=str(tmp_path),\
      \ check=True)\n\n2. Create the .claude/plans/ directory inside the tmp repo:\n\
      \     plans_dir = tmp_path / \".claude\" / \"plans\"\n     plans_dir.mkdir(parents=True)\n\
      \n3. Create an initial commit with a sentinel file so the repo is not empty:\n\
      \     sentinel = tmp_path / \"sentinel.txt\"\n     sentinel.write_text(\"initial\"\
      )\n     subprocess.run([\"git\", \"add\", \".\"], cwd=str(tmp_path), check=True)\n\
      \     subprocess.run([\"git\", \"commit\", \"-m\", \"init\"], cwd=str(tmp_path),\
      \ check=True)\n\n4. Create a file that will be stashed (simulates user work-in-progress):\n\
      \     wip = tmp_path / \"work.txt\"\n     wip.write_text(\"wip\")\n     subprocess.run([\"\
      git\", \"add\", \"work.txt\"], cwd=str(tmp_path), check=True)\n\n5. Create the\
      \ stash (with the wip file):\n     subprocess.run(\n         [\"git\", \"stash\"\
      , \"push\", \"--include-untracked\", \"-m\", ORCHESTRATOR_STASH_MESSAGE],\n\
      \         cwd=str(tmp_path), check=True\n     )\n\n6. Now write task-status.json\
      \ to simulate the orchestrator writing it after task completion\n   (this is\
      \ the file that triggers the bug):\n     status_file = tmp_path / \".claude\"\
      \ / \"plans\" / \"task-status.json\"\n     status_file.write_text('{\"status\"\
      : \"completed\"}')\n\n7. Monkeypatch mod.STATUS_FILE_PATH to the tmp_path version\
      \ so git_stash_pop()\n   uses the correct path:\n     monkeypatch.setattr(mod,\
      \ \"STATUS_FILE_PATH\", str(status_file))\n\n8. Change the working directory\
      \ to tmp_path for git operations:\n     monkeypatch.chdir(tmp_path)\n\n9. Call\
      \ git_stash_pop() and assert it returns True (success):\n     result = mod.git_stash_pop()\n\
      \     assert result is True, \"git_stash_pop() should succeed even with task-status.json\
      \ present\"\n\n10. Assert the wip file was restored (confirming the stash pop\
      \ applied correctly):\n      assert (tmp_path / \"work.txt\").exists(), \"Stashed\
      \ WIP file should be restored\"\n\nRun tests after adding them:\n  ~/.pyenv/versions/3.11.*/bin/python\
      \ -m pytest tests/test_plan_orchestrator.py -v\n\nFix any failures immediately.\n\
      \nFiles: tests/test_plan_orchestrator.py\n"
    attempts: 1
    last_attempt: '2026-02-18T08:42:06.990361'
    model_used: sonnet
    completed_at: '2026-02-18T08:44:41.383787'
    result_message: 'Added test_stash_pop_discards_task_status_json() integration
      test using a real temporary git repo. Test reproduces the bug scenario: stash
      push WIP, then write task-status.json post-stash, then verify git_stash_pop()
      succeeds and WIP is restored. Also added subprocess import and STATUS_FILE_PATH
      to module imports. All 24 tests pass.'
- id: phase-3
  name: Phase 3 - Verification
  status: completed
  tasks:
  - id: '3.1'
    name: Final verification â€” syntax, full test suite, confirm fix
    agent: code-reviewer
    status: completed
    depends_on:
    - '2.1'
    description: "Run all verification checks to confirm the fix is correct and complete.\n\
      \n1. Check Python syntax for both scripts:\n   python3 -c \"import py_compile;\
      \ py_compile.compile('scripts/auto-pipeline.py', doraise=True); py_compile.compile('scripts/plan-orchestrator.py',\
      \ doraise=True)\"\n\n2. Run the full test suite:\n   ~/.pyenv/versions/3.11.*/bin/python\
      \ -m pytest tests/ -v 2>/dev/null || echo 'No test suite configured'\n\n3. Confirm\
      \ the git checkout discard is present in git_stash_pop():\n   grep -n \"checkout.*STATUS_FILE_PATH\\\
      |checkout.*task-status\" scripts/plan-orchestrator.py\n\n4. Confirm the discard\
      \ block appears BEFORE the git stash pop call:\n   grep -n -A2 \"Discard task-status\"\
      \ scripts/plan-orchestrator.py\n\n5. Run orchestrator dry-run to confirm no\
      \ startup errors:\n   python3 scripts/plan-orchestrator.py --plan .claude/plans/sample-plan.yaml\
      \ --dry-run\n\nReport any failures with specific details. All checks must pass.\n\
      \nFiles: scripts/plan-orchestrator.py, tests/test_plan_orchestrator.py\n"
    attempts: 2
    last_attempt: '2026-02-18T08:47:39.291512'
    model_used: sonnet
    completed_at: '2026-02-18T08:49:07.395181'
    result_message: 'All verification checks passed: syntax OK for both scripts, 214/214
      tests pass (including new regression test test_stash_pop_discards_task_status_json),
      git checkout discard confirmed at line 1514 before git stash pop at line 1519,
      orchestrator dry-run succeeds with no startup errors'
