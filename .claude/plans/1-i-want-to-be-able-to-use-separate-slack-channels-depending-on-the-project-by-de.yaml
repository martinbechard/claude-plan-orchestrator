meta:
  name: Per-Project Slack Channel Prefix
  description: Allow each project to configure its own Slack channel name prefix instead
    of the hardcoded "orchestrator-". Add a channel_prefix field to slack.local.yaml
    config, update SlackNotifier to read it, replace the hardcoded SLACK_CHANNEL_ROLES
    dict with a suffix-based lookup, and update _discover_channels and _handle_polled_messages
    to use the configurable prefix.
  plan_doc: docs/plans/2026-02-16-1-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de-design.md
  created: '2026-02-16'
  max_attempts_default: 3
  validation:
    enabled: true
    run_after:
    - coder
    validators:
    - validator
    max_validation_attempts: 1
sections:
- id: phase-1
  name: Phase 1 - Config Template Update
  status: completed
  tasks:
  - id: '1.1'
    name: Add channel_prefix to config template
    agent: coder
    status: completed
    description: "Update the Slack config template to include a channel_prefix field.\n\
      Reference: docs/plans/2026-02-16-1-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de-design.md\n\
      Steps:\n1. Read .claude/slack.local.yaml.template.\n2. After the \"channel_id\"\
      \ line (line 17), add:\n   # Prefix for Slack channel names used by this project.\n\
      \   # Channels are discovered by this prefix + role suffix:\n   #   {prefix}features,\
      \ {prefix}defects, {prefix}questions, {prefix}notifications\n   # Default: \"\
      orchestrator-\"\n   channel_prefix: \"orchestrator-\"\n\n3. Verify the template\
      \ is still valid YAML:\n   python3 -c \"\n   import yaml\n   with open('.claude/slack.local.yaml.template')\
      \ as f:\n       config = yaml.safe_load(f)\n   assert config['slack']['enabled']\
      \ is True\n   assert 'channel_prefix' in config['slack']\n   assert config['slack']['channel_prefix']\
      \ == 'orchestrator-'\n   print('Template validated OK with channel_prefix field')\n\
      \   \"\n\nFiles: .claude/slack.local.yaml.template\n"
    attempts: 1
    last_attempt: '2026-02-16T23:52:12.564666'
    model_used: sonnet
    completed_at: '2026-02-16T23:53:45.931156'
    result_message: Added channel_prefix field to Slack config template with documentation
      and default value 'orchestrator-'
- id: phase-2
  name: Phase 2 - Implementation
  status: completed
  tasks:
  - id: '2.1'
    name: Replace SLACK_CHANNEL_ROLES with suffix-based lookup and update SlackNotifier
    agent: coder
    status: completed
    depends_on:
    - '1.1'
    description: "Update scripts/plan-orchestrator.py to support a configurable channel\
      \ prefix.\nReference: docs/plans/2026-02-16-1-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de-design.md\n\
      Steps:\n1. Read scripts/plan-orchestrator.py. Find the Slack constants section\
      \ (lines 88-94).\n2. Replace the SLACK_CHANNEL_ROLES dict with a suffix-based\
      \ mapping.\n   Change:\n     SLACK_CHANNEL_ROLES = {\n         \"orchestrator-features\"\
      : \"feature\",\n         \"orchestrator-defects\": \"defect\",\n         \"\
      orchestrator-questions\": \"question\",\n         \"orchestrator-notifications\"\
      : \"control\",\n     }\n   To:\n     SLACK_CHANNEL_ROLE_SUFFIXES = {\n     \
      \    \"features\": \"feature\",\n         \"defects\": \"defect\",\n       \
      \  \"questions\": \"question\",\n         \"notifications\": \"control\",\n\
      \     }\n   Keep SLACK_CHANNEL_PREFIX = \"orchestrator-\" as the default.\n\n\
      3. In SlackNotifier.__init__ (around line 2617), after self._channels_discovered_at\
      \ = 0.0,\n   add:\n     self._channel_prefix = SLACK_CHANNEL_PREFIX\n   Then\
      \ in the config loading block (after self._question_config is set, around line\
      \ 2658),\n   add:\n     prefix = slack_config.get(\"channel_prefix\", \"\")\n\
      \     if prefix:\n         # Ensure prefix ends with a separator\n         if\
      \ not prefix.endswith(\"-\"):\n             prefix += \"-\"\n         self._channel_prefix\
      \ = prefix\n\n4. In _discover_channels (around line 3016), change:\n     if\
      \ name.startswith(SLACK_CHANNEL_PREFIX):\n   To:\n     if name.startswith(self._channel_prefix):\n\
      \n5. Add a new method _get_channel_role right after _discover_channels:\n  \
      \   def _get_channel_role(self, channel_name: str) -> str:\n         \"\"\"\
      Get the role for a channel name based on its suffix.\n\n         Strips the\
      \ configured prefix and looks up the remaining suffix\n         in SLACK_CHANNEL_ROLE_SUFFIXES.\n\
      \n         Returns the role string (e.g. \"feature\", \"defect\") or empty\n\
      \         string if the suffix is not recognized.\n         \"\"\"\n       \
      \  if not channel_name.startswith(self._channel_prefix):\n             return\
      \ \"\"\n         suffix = channel_name[len(self._channel_prefix):]\n       \
      \  return SLACK_CHANNEL_ROLE_SUFFIXES.get(suffix, \"\")\n\n6. In _handle_polled_messages\
      \ (around line 3690), change:\n     channel_role = SLACK_CHANNEL_ROLES.get(channel_name,\
      \ \"\")\n   To:\n     channel_role = self._get_channel_role(channel_name)\n\n\
      7. Update the docstring of _discover_channels to say \"prefix-* channels\"\n\
      \   instead of \"orchestrator-* channels\".\n\n8. Update the docstring of poll_messages\
      \ to say \"prefix-* channels\"\n   instead of \"orchestrator-* channels\".\n\
      \n9. Verify syntax:\n   python3 -c \"import py_compile; py_compile.compile('scripts/plan-orchestrator.py',\
      \ doraise=True); print('syntax OK')\"\n\n10. Verify the new constant and method\
      \ exist:\n    python3 -c \"\n    import importlib.util\n    spec = importlib.util.spec_from_file_location('po',\
      \ 'scripts/plan-orchestrator.py')\n    mod = importlib.util.module_from_spec(spec)\n\
      \    spec.loader.exec_module(mod)\n    assert hasattr(mod, 'SLACK_CHANNEL_ROLE_SUFFIXES'),\
      \ 'Missing SLACK_CHANNEL_ROLE_SUFFIXES'\n    assert 'features' in mod.SLACK_CHANNEL_ROLE_SUFFIXES,\
      \ 'Missing features suffix'\n    notifier = mod.SlackNotifier('/nonexistent')\n\
      \    assert hasattr(notifier, '_get_channel_role'), 'Missing _get_channel_role'\n\
      \    assert hasattr(notifier, '_channel_prefix'), 'Missing _channel_prefix'\n\
      \    assert notifier._channel_prefix == 'orchestrator-', f'Wrong default prefix:\
      \ {notifier._channel_prefix}'\n    print('Channel prefix refactoring verified\
      \ OK')\n    \"\n\nFiles: scripts/plan-orchestrator.py\n"
    attempts: 1
    last_attempt: '2026-02-16T23:53:51.867266'
    model_used: sonnet
    completed_at: '2026-02-16T23:57:13.285171'
    result_message: Replaced SLACK_CHANNEL_ROLES with suffix-based lookup and added
      configurable channel prefix support
- id: phase-3
  name: Phase 3 - Unit Tests
  status: completed
  tasks:
  - id: '3.1'
    name: Add tests for configurable channel prefix
    agent: coder
    status: completed
    depends_on:
    - '2.1'
    description: "Add unit tests for the configurable channel prefix to tests/test_slack_notifier.py.\n\
      Reference: docs/plans/2026-02-16-1-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de-design.md\n\
      Steps:\n1. Read tests/test_slack_notifier.py and scripts/plan-orchestrator.py\
      \ to understand\n   the current test structure and the new _channel_prefix /\
      \ _get_channel_role /\n   SLACK_CHANNEL_ROLE_SUFFIXES implementation.\n\n2.\
      \ Add the following test cases:\n\n   a. test_default_channel_prefix:\n    \
      \  Create a SlackNotifier with a valid config that has NO channel_prefix field.\n\
      \      Assert notifier._channel_prefix == \"orchestrator-\".\n\n   b. test_custom_channel_prefix:\n\
      \      Create a config YAML in tmp_path with:\n        slack:\n          enabled:\
      \ true\n          bot_token: \"xoxb-test\"\n          channel_id: \"C123\"\n\
      \          channel_prefix: \"myproject-\"\n      Create SlackNotifier with this\
      \ config.\n      Assert notifier._channel_prefix == \"myproject-\".\n\n   c.\
      \ test_channel_prefix_auto_append_dash:\n      Create a config with channel_prefix:\
      \ \"myproject\" (no trailing dash).\n      Assert notifier._channel_prefix ==\
      \ \"myproject-\" (dash appended).\n\n   d. test_get_channel_role_default_prefix:\n\
      \      Create a disabled SlackNotifier (default prefix).\n      Assert notifier._get_channel_role(\"\
      orchestrator-features\") == \"feature\".\n      Assert notifier._get_channel_role(\"\
      orchestrator-defects\") == \"defect\".\n      Assert notifier._get_channel_role(\"\
      orchestrator-questions\") == \"question\".\n      Assert notifier._get_channel_role(\"\
      orchestrator-notifications\") == \"control\".\n      Assert notifier._get_channel_role(\"\
      orchestrator-unknown\") == \"\".\n      Assert notifier._get_channel_role(\"\
      other-channel\") == \"\".\n\n   e. test_get_channel_role_custom_prefix:\n  \
      \    Create a SlackNotifier with channel_prefix: \"proj-\".\n      Assert notifier._get_channel_role(\"\
      proj-features\") == \"feature\".\n      Assert notifier._get_channel_role(\"\
      proj-defects\") == \"defect\".\n      Assert notifier._get_channel_role(\"orchestrator-features\"\
      ) == \"\"\n      (wrong prefix returns empty).\n\n   f. test_slack_channel_role_suffixes_constant:\n\
      \      Assert mod.SLACK_CHANNEL_ROLE_SUFFIXES has exactly 4 entries:\n     \
      \ features->feature, defects->defect, questions->question,\n      notifications->control.\n\
      \      Also assert that the old SLACK_CHANNEL_ROLES constant no longer\n   \
      \   exists (getattr(mod, 'SLACK_CHANNEL_ROLES', None) is None).\n\n3. Run all\
      \ tests:\n   python3 -m pytest tests/test_slack_notifier.py -v\n   Fix any failures.\n\
      \nFiles: tests/test_slack_notifier.py\n"
    attempts: 1
    last_attempt: '2026-02-16T23:57:16.831428'
    model_used: sonnet
    completed_at: '2026-02-17T00:01:38.795966'
    result_message: Added 6 comprehensive unit tests for configurable channel prefix
      feature, all tests pass
- id: phase-4
  name: Phase 4 - Verification
  status: pending
  tasks:
  - id: '4.1'
    name: Verify syntax, tests, and dry-run
    agent: code-reviewer
    status: pending
    depends_on:
    - '3.1'
    description: "Run verification checks to confirm the per-project channel prefix\
      \ feature works.\nSteps:\n1. Check Python syntax for both scripts:\n   python3\
      \ -c \"import py_compile; py_compile.compile('scripts/auto-pipeline.py', doraise=True);\
      \ py_compile.compile('scripts/plan-orchestrator.py', doraise=True)\"\n\n2. Run\
      \ all unit tests:\n   python3 -m pytest tests/ 2>/dev/null || echo 'No test\
      \ suite configured'\n\n3. Verify SLACK_CHANNEL_ROLE_SUFFIXES replaces SLACK_CHANNEL_ROLES:\n\
      \   python3 -c \"\n   import importlib.util\n   spec = importlib.util.spec_from_file_location('po',\
      \ 'scripts/plan-orchestrator.py')\n   mod = importlib.util.module_from_spec(spec)\n\
      \   spec.loader.exec_module(mod)\n   assert hasattr(mod, 'SLACK_CHANNEL_ROLE_SUFFIXES'),\
      \ 'Missing SLACK_CHANNEL_ROLE_SUFFIXES'\n   assert not hasattr(mod, 'SLACK_CHANNEL_ROLES'),\
      \ 'SLACK_CHANNEL_ROLES should be removed'\n   suffixes = mod.SLACK_CHANNEL_ROLE_SUFFIXES\n\
      \   assert suffixes['features'] == 'feature'\n   assert suffixes['defects']\
      \ == 'defect'\n   assert suffixes['questions'] == 'question'\n   assert suffixes['notifications']\
      \ == 'control'\n   print('SLACK_CHANNEL_ROLE_SUFFIXES verified')\n   \"\n\n\
      4. Verify SlackNotifier reads channel_prefix from config:\n   python3 -c \"\n\
      \   import importlib.util, tempfile, os, yaml\n   spec = importlib.util.spec_from_file_location('po',\
      \ 'scripts/plan-orchestrator.py')\n   mod = importlib.util.module_from_spec(spec)\n\
      \   spec.loader.exec_module(mod)\n   # Test default prefix\n   notifier = mod.SlackNotifier('/nonexistent')\n\
      \   assert notifier._channel_prefix == 'orchestrator-', 'Bad default prefix'\n\
      \   # Test custom prefix via config\n   with tempfile.NamedTemporaryFile(mode='w',\
      \ suffix='.yaml', delete=False) as f:\n       yaml.dump({'slack': {'enabled':\
      \ True, 'bot_token': 'xoxb-test', 'channel_id': 'C1', 'channel_prefix': 'myproj-'}},\
      \ f)\n       tmp = f.name\n   try:\n       n2 = mod.SlackNotifier(config_path=tmp)\n\
      \       assert n2._channel_prefix == 'myproj-', f'Bad custom prefix: {n2._channel_prefix}'\n\
      \   finally:\n       os.unlink(tmp)\n   print('channel_prefix config loading\
      \ verified')\n   \"\n\n5. Verify _get_channel_role works:\n   python3 -c \"\n\
      \   import importlib.util\n   spec = importlib.util.spec_from_file_location('po',\
      \ 'scripts/plan-orchestrator.py')\n   mod = importlib.util.module_from_spec(spec)\n\
      \   spec.loader.exec_module(mod)\n   notifier = mod.SlackNotifier('/nonexistent')\n\
      \   assert notifier._get_channel_role('orchestrator-features') == 'feature'\n\
      \   assert notifier._get_channel_role('orchestrator-defects') == 'defect'\n\
      \   assert notifier._get_channel_role('other-features') == ''\n   print('_get_channel_role\
      \ verified')\n   \"\n\n6. Verify config template has channel_prefix field:\n\
      \   python3 -c \"\n   import yaml\n   with open('.claude/slack.local.yaml.template')\
      \ as f:\n       config = yaml.safe_load(f)\n   assert 'channel_prefix' in config['slack'],\
      \ 'Missing channel_prefix in template'\n   assert config['slack']['channel_prefix']\
      \ == 'orchestrator-'\n   print('Config template has channel_prefix field')\n\
      \   \"\n\n7. Run orchestrator dry-run to verify no startup errors:\n   python3\
      \ scripts/plan-orchestrator.py --plan .claude/plans/sample-plan.yaml --dry-run\n\
      \nIf any check fails, report the failure with specific details.\nFiles: scripts/plan-orchestrator.py,\
      \ scripts/auto-pipeline.py,\n       .claude/slack.local.yaml.template, tests/test_slack_notifier.py\n"
