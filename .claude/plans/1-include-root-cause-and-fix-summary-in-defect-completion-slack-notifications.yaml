meta:
  name: Include Root Cause and Fix Summary in Defect Completion Slack Notifications
  description: Extract a concise root cause and fix summary from completed defect
    markdown files and append it to the Slack notification messages in both the notifications
    channel and the type-specific defects channel.
  plan_doc: docs/plans/2026-02-21-1-include-root-cause-and-fix-summary-in-defect-completion-slack-notifications-design.md
  source_item: docs/feature-backlog/1-include-root-cause-and-fix-summary-in-defect-completion-slack-notifications.md
  created: '2026-02-21'
  max_attempts_default: 3
  validation:
    enabled: true
    run_after:
    - coder
    - e2e-test-agent
    - frontend-coder
    validators:
    - validator
    max_validation_attempts: 2
sections:
- id: phase-1
  name: Phase 1 - Implementation
  status: completed
  tasks:
  - id: '1.1'
    name: Add _extract_completion_summary() and integrate into _archive_and_report()
    agent: coder
    status: completed
    description: "Implement the work item: docs/feature-backlog/1-include-root-cause-and-fix-summary-in-defect-completion-slack-notifications.md\n\
      Design doc: docs/plans/2026-02-21-1-include-root-cause-and-fix-summary-in-defect-completion-slack-notifications-design.md\n\
      In scripts/auto-pipeline.py:\n1. Add a constant MAX_SUMMARY_LENGTH = 300 near\
      \ the other constants at the\n   top of the file.\n\n2. Add a new module-level\
      \ function _extract_completion_summary(item_path: str) -> str\n   placed immediately\
      \ before _archive_and_report(). The function should:\n   - Read the markdown\
      \ file at item_path\n   - Extract \"what was wrong\" from (in priority order):\n\
      \     a. First sentence of ## Root Cause section\n     b. The **Root Need:**\
      \ line from 5 Whys analysis\n     c. First sentence of ## Summary section\n\
      \   - Extract \"what was fixed\" from the last ## Verification Log entry:\n\
      \     a. Lines from **Findings:** that mention \"fix\" or \"commit\"\n     b.\
      \ Fall back to the **Verdict:** line\n   - Combine into a concise string, truncated\
      \ to MAX_SUMMARY_LENGTH\n   - Return empty string on any read error or if no\
      \ sections found\n   - Use the existing regex patterns in the codebase (re.search\
      \ with\n     re.MULTILINE | re.DOTALL for section extraction)\n\n3. Modify _archive_and_report()\
      \ to:\n   - Call _extract_completion_summary(item.path) BEFORE archive_item()\n\
      \     (the file is moved during archive, making item.path stale after)\n   -\
      \ Store the result in a local variable summary\n   - Build summary_block = f\"\
      \\n{summary}\" if summary else \"\"\n   - Append summary_block to both existing\
      \ send_status() message strings\n     (the notifications channel message and\
      \ the type-specific channel\n     cross-post message)\n\n4. Verify syntax: python3\
      \ -c \"import py_compile; py_compile.compile('scripts/auto-pipeline.py', doraise=True)\"\
      \nFiles: scripts/auto-pipeline.py\n"
    attempts: 3
    last_attempt: '2026-02-21T00:34:39.062143'
    model_used: sonnet
    validation_findings: 'Validator ''validator'' failed to execute: No status file
      written by Claude'
    validation_attempts: 2
    completed_at: '2026-02-21T00:35:24.509364'
    result_message: Added MAX_SUMMARY_LENGTH constant, _extract_completion_summary()
      function, and integrated it into _archive_and_report() - summary is extracted
      before archive_item() call and appended to both Slack notification messages
- id: phase-2
  name: Phase 2 - Unit Tests
  status: pending
  tasks:
  - id: '2.1'
    name: Add unit tests for _extract_completion_summary()
    agent: coder
    status: pending
    depends_on:
    - '1.1'
    description: "Implement the work item: docs/feature-backlog/1-include-root-cause-and-fix-summary-in-defect-completion-slack-notifications.md\n\
      Design doc: docs/plans/2026-02-21-1-include-root-cause-and-fix-summary-in-defect-completion-slack-notifications-design.md\n\
      Add unit tests for _extract_completion_summary() to tests/test_auto_pipeline.py.\
      \ Follow the existing test patterns in that file (use tmp_path fixture for creating\
      \ temporary markdown files).\nTests to add:\n1. test_extract_completion_summary_with_root_cause_section:\n\
      \   - Create a markdown file with ## Root Cause section containing a\n     multi-sentence\
      \ paragraph\n   - Verify the first sentence of Root Cause is included in the\
      \ result\n\n2. test_extract_completion_summary_with_root_need_line:\n   - Create\
      \ a markdown file with **Root Need:** line but no ## Root Cause\n   - Verify\
      \ the Root Need content is included\n\n3. test_extract_completion_summary_with_summary_only:\n\
      \   - Create a markdown file with only ## Summary section\n   - Verify the first\
      \ sentence of Summary is used as fallback\n\n4. test_extract_completion_summary_with_verification_findings:\n\
      \   - Create a markdown file with ## Verification Log containing findings\n\
      \     that mention \"fix\" or \"commit\"\n   - Verify the fix-related findings\
      \ are included\n\n5. test_extract_completion_summary_truncation:\n   - Create\
      \ a markdown file with very long Root Cause and findings\n   - Verify the result\
      \ is truncated to MAX_SUMMARY_LENGTH\n\n6. test_extract_completion_summary_file_not_found:\n\
      \   - Call with a nonexistent path\n   - Verify empty string is returned (no\
      \ exception raised)\n\n7. test_extract_completion_summary_empty_file:\n   -\
      \ Create an empty markdown file\n   - Verify empty string is returned\n\nRun\
      \ tests: ~/.pyenv/versions/3.11.*/bin/python -m pytest tests/test_auto_pipeline.py\
      \ -v Fix any failures.\nFiles: tests/test_auto_pipeline.py\n"
