meta:
  name: Per-Project Slack Channel Prefix (Duplicate Verification)
  description: >
    Verify that the per-project Slack channel prefix feature (backlog item #2)
    is already implemented by item #1. Run verification checks, confirm tests
    pass, and archive the duplicate backlog item.
  plan_doc: docs/plans/2026-02-17-2-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de-design.md
  created: '2026-02-17'
  max_attempts_default: 3
  validation:
    enabled: true
    run_after:
    - coder
    validators:
    - validator
    max_validation_attempts: 1
sections:
- id: phase-1
  name: Phase 1 - Verification
  status: pending
  tasks:
  - id: '1.1'
    name: Verify per-project channel prefix implementation
    agent: code-reviewer
    status: pending
    description: >
      Verify the per-project Slack channel prefix feature is fully implemented.
      This backlog item (#2) is a duplicate of item #1, which was completed on
      2026-02-16.

      Steps:

      1. Check Python syntax for both scripts:
         python3 -c "import py_compile; py_compile.compile('scripts/auto-pipeline.py', doraise=True); py_compile.compile('scripts/plan-orchestrator.py', doraise=True)"

      2. Run all unit tests:
         python3 -m pytest tests/ 2>/dev/null || echo 'No test suite configured'

      3. Verify SLACK_CHANNEL_ROLE_SUFFIXES exists and SLACK_CHANNEL_ROLES is removed:
         python3 -c "
         import importlib.util
         spec = importlib.util.spec_from_file_location('po', 'scripts/plan-orchestrator.py')
         mod = importlib.util.module_from_spec(spec)
         spec.loader.exec_module(mod)
         assert hasattr(mod, 'SLACK_CHANNEL_ROLE_SUFFIXES'), 'Missing SLACK_CHANNEL_ROLE_SUFFIXES'
         assert not hasattr(mod, 'SLACK_CHANNEL_ROLES'), 'Old SLACK_CHANNEL_ROLES should be removed'
         suffixes = mod.SLACK_CHANNEL_ROLE_SUFFIXES
         assert suffixes['features'] == 'feature'
         assert suffixes['defects'] == 'defect'
         assert suffixes['questions'] == 'question'
         assert suffixes['notifications'] == 'control'
         print('SLACK_CHANNEL_ROLE_SUFFIXES verified')
         "

      4. Verify SlackNotifier reads channel_prefix from config:
         python3 -c "
         import importlib.util, tempfile, os, yaml
         spec = importlib.util.spec_from_file_location('po', 'scripts/plan-orchestrator.py')
         mod = importlib.util.module_from_spec(spec)
         spec.loader.exec_module(mod)
         notifier = mod.SlackNotifier('/nonexistent')
         assert notifier._channel_prefix == 'orchestrator-', 'Bad default prefix'
         with tempfile.NamedTemporaryFile(mode='w', suffix='.yaml', delete=False) as f:
             yaml.dump({'slack': {'enabled': True, 'bot_token': 'xoxb-test', 'channel_id': 'C1', 'channel_prefix': 'myproj-'}}, f)
             tmp = f.name
         try:
             n2 = mod.SlackNotifier(config_path=tmp)
             assert n2._channel_prefix == 'myproj-', f'Bad custom prefix: {n2._channel_prefix}'
         finally:
             os.unlink(tmp)
         print('channel_prefix config loading verified')
         "

      5. Verify _get_channel_role works with custom prefix:
         python3 -c "
         import importlib.util
         spec = importlib.util.spec_from_file_location('po', 'scripts/plan-orchestrator.py')
         mod = importlib.util.module_from_spec(spec)
         spec.loader.exec_module(mod)
         notifier = mod.SlackNotifier('/nonexistent')
         assert notifier._get_channel_role('orchestrator-features') == 'feature'
         assert notifier._get_channel_role('orchestrator-defects') == 'defect'
         assert notifier._get_channel_role('other-features') == ''
         print('_get_channel_role verified')
         "

      6. Verify config template has channel_prefix field:
         python3 -c "
         import yaml
         with open('.claude/slack.local.yaml.template') as f:
             config = yaml.safe_load(f)
         assert 'channel_prefix' in config['slack'], 'Missing channel_prefix in template'
         assert config['slack']['channel_prefix'] == 'orchestrator-'
         print('Config template has channel_prefix field')
         "

      7. Run orchestrator dry-run to verify no startup errors:
         python3 scripts/plan-orchestrator.py --plan .claude/plans/sample-plan.yaml --dry-run

      If any check fails, report the failure with specific details.

      Files: scripts/plan-orchestrator.py, scripts/auto-pipeline.py,
             .claude/slack.local.yaml.template, tests/test_slack_notifier.py

- id: phase-2
  name: Phase 2 - Archive Duplicate
  status: pending
  tasks:
  - id: '2.1'
    name: Archive duplicate backlog item
    agent: coder
    status: pending
    depends_on:
    - '1.1'
    description: >
      Move the duplicate backlog item to completed-backlog.

      Steps:

      1. Read docs/feature-backlog/2-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de.md

      2. Update the status from "Open" to "Closed (Duplicate)" and add a note
         explaining this is a duplicate of item #1.

      3. Move the file to docs/completed-backlog/features/ using git mv:
         git mv "docs/feature-backlog/2-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de.md" "docs/completed-backlog/features/2-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de.md"

      4. Verify the file was moved:
         python3 -c "
         import os
         src = 'docs/feature-backlog/2-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de.md'
         dst = 'docs/completed-backlog/features/2-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de.md'
         assert not os.path.exists(src), f'Source still exists: {src}'
         assert os.path.exists(dst), f'Destination missing: {dst}'
         with open(dst) as f:
             content = f.read()
         assert 'Duplicate' in content, 'Missing duplicate note in file'
         print('Backlog item archived as duplicate')
         "

      Files: docs/feature-backlog/2-i-want-to-be-able-to-use-separate-slack-channels-depending-on-the-project-by-de.md
